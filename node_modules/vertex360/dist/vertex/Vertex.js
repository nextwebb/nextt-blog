"use strict";var _prototypeProperties=function(e,t,r){t&&Object.defineProperties(e,t),r&&Object.defineProperties(e.prototype,r)},_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},decode=require("urldecode"),formatCallback=require("./callback"),adminRest=require("./adminRest"),authHandler=require("./authHandler"),Router=require("./Router"),db=require("./db"),generateErrorCallback=function(e,t,r){return{isBase64Encoded:!1,statusCode:t,headers:r||{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:{message:e.message,stack:e.stack}})}},generateSuccessCallback=function(e,t){return{isBase64Encoded:!1,statusCode:200,headers:t||{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"success",data:e})}},logString=function(e){var t=e.httpMethod.toLowerCase(),r=t.toUpperCase()+" "+e.path;return null!=e.headers["User-Agent"]&&(r+=" "+e.headers["User-Agent"]),null==e.requestContext?r:null==e.requestContext.identity?r:null==e.requestContext.identity.sourceIp?r:r+=" "+e.requestContext.identity.sourceIp},Vertex=function(){function e(t){if(_classCallCheck(this,e),this.routes=[],this.middleware=[],this.staticDir="public",this.opts=t,this.logging=!1,null!=t){this.staticDir=t.static||"public",this.logging=t.logging||!1;var r=t.db;null!=r&&(null==r.type?db.connect(r.url,r.onError,r.onSuccess):"mongo"==r.type?db.connectMongo(r.url,r.onError,r.onSuccess):"nedb"==r.type?db.connectNedb(r.url,r.onError,r.onSuccess):db.connectMongo(r.url,r.onError,r.onSuccess))}}return _prototypeProperties(e,null,{expressVersion:{value:function(e){var t=this;return e.use("/turbo",function(e,r,n){r.json({confirmation:"success",data:JSON.stringify(t.routes)})}),t.routes.forEach(function(t){e.use(t.stem,function(e,r,n){r.json({confirmation:"success",data:t.stem})})}),e},writable:!0,configurable:!0},useStatic:{value:function(e){this.staticDir=e},writable:!0,configurable:!0},use:{value:function(e,t){if(null==t)return void this.middleware.push(e);t.setStem(e),this.routes.push(t)},writable:!0,configurable:!0},get:{value:function(e,t){var r=new Router;r.setStem("/"),r.get(e,t),this.routes.push(r)},writable:!0,configurable:!0},post:{value:function(e,t){var r=new Router;r.setStem("/"),r.post(e,t),this.routes.push(r)},writable:!0,configurable:!0},routeNotFound:{value:function(e,t){e.httpMethod.toLowerCase();return{isBase64Encoded:!1,statusCode:501,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",message:t})}},writable:!0,configurable:!0},handle:{value:function(e){var t=this,r=e.event,n=e.callback,o=r.httpMethod.toLowerCase(),a=r.headers["turbo-vertex-client"];if("admin-dashboard"==a||"mothership"==a){var l=this.opts.controllers||null;return null==l?void n(null,generateErrorCallback(new Error("controllers not defined. check config settings."),500)):void adminRest(l,r).then(function(e){n(null,generateSuccessCallback(e))}).catch(function(e){n(null,generateErrorCallback(e,500))})}if("vertex-sdk"==a){var i=function(){var e=r.path,t=[];e.split("/").forEach(function(e){e.length>0&&"/"!=e&&t.push(e)});var o={message:"site pinged"};return 0==t.length?(n(null,generateSuccessCallback(o)),{v:void 0}):(t[0],n(null,generateSuccessCallback(o)),{v:void 0})}();if("object"==typeof i)return i.v}if("widget-auth"==a)return void authHandler(r).then(function(e){var t={"Content-Type":"application/json"};null!=e.cookie&&(t["Set-Cookie"]=e.cookie),n(null,generateSuccessCallback({vertexUser:e.vertexUser},t))}).catch(function(e){n(null,generateErrorCallback(e,500))});if(this.logging){var u=logString(r);console.log(u)}if("post"==o){var s=function(){for(var e=null,a=0;a<t.routes.length;a++){var l=t.routes[a];if(null!=l.handlePost(r)){e=l.handlePost(r);break}}return null==e?(n(null,t.routeNotFound(r,o+" route not defined for this path: "+r.path)),{v:void 0}):(formatCallback(r,n,e.routeParams,t.opts,t.middleware,function(t,r){if(null!=t)return void n(null,generateErrorCallback(t,500));try{e.routeHandler(r.req,r.res)}catch(t){return void n(null,generateErrorCallback(t,500))}}),{v:void 0})}();if("object"==typeof s)return s.v}if("put"==o){var c=function(){for(var e=null,a=0;a<t.routes.length;a++){var l=t.routes[a];if(null!=l.handlePut(r)){e=l.handlePut(r);break}}return null==e?(n(null,t.routeNotFound(r,o+" route not defined for this path: "+r.path)),{v:void 0}):(formatCallback(r,n,e.routeParams,t.opts,t.middleware,function(t,r){if(null!=t)return void n(null,generateErrorCallback(t,500));try{e.routeHandler(r.req,r.res)}catch(t){return void n(null,generateErrorCallback(t,500))}}),{v:void 0})}();if("object"==typeof c)return c.v}if("delete"==o){var d=function(){for(var e=null,a=0;a<t.routes.length;a++){var l=t.routes[a];if(null!=l.handleDelete(r)){e=l.handleDelete(r);break}}return null==e?(n(null,t.routeNotFound(r,o+" route not defined for this path: "+r.path)),{v:void 0}):(formatCallback(r,n,e.routeParams,t.opts,t.middleware,function(t,r){if(null!=t)return void n(null,generateErrorCallback(t,500));try{e.routeHandler(r.req,r.res)}catch(t){return void n(null,generateErrorCallback(t,500))}}),{v:void 0})}();if("object"==typeof d)return d.v}if("get"==o){if(-1==r.path.indexOf(".")){var f=function(){for(var e=null,a=0;a<t.routes.length;a++){var l=t.routes[a];if(null!=l.handleGet(r)){e=l.handleGet(r);break}}return null==e?(n(null,t.routeNotFound(r,o+" route not defined for this path: "+r.path)),{v:void 0}):(formatCallback(r,n,e.routeParams,t.opts,t.middleware,function(t,r){if(null!=t)return void n(null,generateErrorCallback(t,500));try{e.routeHandler(r.req,r.res)}catch(t){return void n(null,generateErrorCallback(t,500))}}),{v:void 0})}();if("object"==typeof f)return f.v}if(void 0==r.headers||null==r.headers)return void n(null,{isBase64Encoded:!1,statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:"Missing Turbo-Vertex-App header (headers is null)"})});var h=r.headers["Turbo-Vertex-App"],p=this.staticDir||"public",v=null;if(null==this.opts){if(null==h)return void n(null,{isBase64Encoded:!1,statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:"Missing Turbo-Vertex-App header"})});var b="cdn.turbo360-vertex.com/"+h+"/"+p+r.path;v=b.replace("//","/")}else if(null==this.opts.bucket){if(null==h)return void n(null,{isBase64Encoded:!1,statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:"Missing Turbo-Vertex-App header"})});var b="cdn.turbo360-vertex.com/"+h+"/"+p+r.path;v=b.replace("//","/")}else v="s3.amazonaws.com/"+this.opts.bucket+"/"+p+r.path;n(null,{isBase64Encoded:!1,statusCode:301,headers:{Location:"https://"+v},body:""})}},writable:!0,configurable:!0}}),e}();module.exports=Vertex;