"use strict";var decode=require("urldecode"),parseBody=function(e){if(null==e.body)return null;var t={};try{t=JSON.parse(e.body)}catch(n){var r=e.body.split("&");r.forEach(function(e,r){var n=e.split("=");2==n.length&&(t[n[0]]=decode(n[1]))})}return t},handleSchemaRequest=function(e,t){if(-1==["get","post"].indexOf(e.method))throw new Error("Invalid HTTP method: "+e.method);var r=[];return Object.keys(t).forEach(function(e){var n=t[e],o=new n;r.push({name:e,collectionName:o.collectionName(),schema:o.schema()})}),r},handleCollectionRequest=function(e,t){return new Promise(function(r,n){if(-1==["get","post"].indexOf(e.method))return void n(new Error("Invalid HTTP method: "+e.method));var o=t[e.resource];if(null==o)return void n(new Error("invalid resource: "+e.resource));var i=new o;if("get"==e.method){var c=e.event.queryStringParameters||{};i.get(c).then(function(e){r(e)}).catch(function(e){n(e)})}else if("post"==e.method){var u=parseBody(e.event);if(null==u)return void n(new Error("Missing request body."));i.post(u).then(function(e){r(e)}).catch(function(e){n(e)})}else n(new Error("invalid HTTP method: "+e.method))})},handleRecordRequest=function(e,t){var r=["get","put","delete"];return new Promise(function(n,o){if(-1==r.indexOf(e.method))return void o(new Error("Invalid HTTP method: "+e.method));var i=t[e.resource];if(null==i)return void o(new Error("invalid resource: "+e.resource));var c=new i;if("get"==e.method&&c.getById(e.id).then(function(e){n(e)}).catch(function(e){o(e)}),"put"==e.method){var u=parseBody(e.event);if(null==u)return void o(new Error("Missing request body"));c.put(e.id,u).then(function(e){n(e)}).catch(function(e){o(e)})}"delete"==e.method&&function(){var t=e.id;c.delete(t).then(function(e){n({id:t})}).catch(function(e){o(e)})}()})};module.exports=function(e,t){return new Promise(function(r,n){var o=t.path,i=o.split("/"),c=[],u=t.httpMethod.toLowerCase();if(i.forEach(function(e){e.length>0&&"/"!=e&&c.push(e)}),0==c.length)return void n(new Error("invalid path. must folow /api/:resource/:id"));if("api"!=c[0])return void n(new Error("invalid path. must folow /api/:resource/:id"));var d={method:u,event:t};if(1==c.length?d.type="schema":2==c.length?(d.type="collection",d.resource=c[1].trim().toLowerCase()):(d.type="record",d.resource=c[1].trim().toLowerCase(),d.id=c[2].trim()),"schema"!=d.type)return"collection"==d.type?void handleCollectionRequest(d,e).then(function(e){r(e)}).catch(function(e){n(e)}):"record"==d.type?void handleRecordRequest(d,e).then(function(e){r(e)}).catch(function(e){n(e)}):void n(new Error("Invalid Request"));try{var a=handleSchemaRequest(d,e);return void r(a)}catch(e){return void n(e)}})};