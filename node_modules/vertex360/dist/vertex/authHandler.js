"use strict";var cookie=require("cookie"),sessions=require("client-sessions"),utils=require("./utils"),COOKIE_NAME="vertexSession",VERTEX360_URL="https://vertex360.herokuapp.com",parseBody=function(e){if(null==e.body)return null;var r={};try{r=JSON.parse(e.body)}catch(n){var t=e.body.split("&");t.forEach(function(e,t){var n=e.split("=");2==n.length&&(r[n[0]]=decode(n[1]))})}return r},parseSession=function(e,r){return new Promise(function(t,n){var o=e.headers.Cookie;if(null==o)return void t(null);var i=cookie.parse(o);if(null==i[r])return void t(null);try{var s=sessions.util.decode({cookieName:r,secret:"abc"},i[r]);if(null==s)return void t(null);if(null==s.content)return void t(null);t(JSON.parse(s.content))}catch(e){return void n(e)}})},validateRequest=function(e){var r=parseBody(e);if(null==r)throw new Error("Missing post body.");var t=e.headers["VERTEX-TOKEN"]||e.headers["vertex-token"];if(null==t)throw new Error("Invalid request.");return{user:r,token:t}},generateCookieString=function(e,r){if(null==r){return e+"=deleted; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT"}var t=JSON.stringify(r);return e+"="+sessions.util.encode({cookieName:e,secret:"abc"},t,null,null)+"; path=/; max-age=1209600"};module.exports=function(e){return new Promise(function(r,t){var n=e.path,o=n.split("/"),i=[];e.httpMethod.toLowerCase();if(o.forEach(function(e){e.length>0&&"/"!=e&&i.push(e)}),2!=i.length)return void t(new Error("invalid path. must folow /auth/:action"));if("auth"!=i[0])return void t(new Error("invalid path. must folow /auth/:action"));var s=i[1];if("login"==s){var u=null;try{u=validateRequest(e)}catch(e){return void t(e)}return void utils.post(VERTEX360_URL+"/account/verifytoken",{profile:u.user.id,token:u.token}).then(function(e){if("success"!=e.confirmation)throw new Error(e.message);r({vertexUser:e.user,cookie:generateCookieString(COOKIE_NAME,{vertexUser:e.user})})}).catch(function(e){t(e)})}if("token"==s){var a=parseBody(e);return null==a?void t(new Error("Missing post body.")):(a.encode="base64",void utils.post(VERTEX360_URL+"/account/verifytoken",a).then(function(e){if("success"!=e.confirmation)throw new Error(e.message);r({vertexUser:e.user,cookie:generateCookieString(COOKIE_NAME,{vertexUser:e.user})})}).catch(function(e){t(e)}))}if("register"==s){var u=null;try{u=validateRequest(e)}catch(e){return void t(e)}return void utils.post(VERTEX360_URL+"/account/verifytoken",{profile:u.user.id,token:u.token}).then(function(e){if("success"!=e.confirmation)throw new Error(e.message);r({vertexUser:e.user,cookie:generateCookieString(COOKIE_NAME,{vertexUser:e.user})})}).catch(function(e){t(e)})}return"currentuser"==s?void parseSession(e,COOKIE_NAME).then(function(e){var t=e?e.vertexUser:null;r({vertexUser:t,cookie:null})}).catch(function(e){r({vertexUser:null,cookie:null})}):"logout"==s?void r({vertexUser:null,cookie:generateCookieString(COOKIE_NAME,null)}):void t(new Error("Invalid auth action: "+s))})};