var Vertex=require("./vertex/Vertex"),Router=require("./vertex/Router"),APIRouter=require("./vertex/APIRouter"),Controller=require("./vertex/Controller"),ConfigRouter=require("./vertex/ConfigRouter"),PaypalClient=require("./vertex/PaypalClient"),utils=require("./vertex/utils"),local=require("./vertex/local"),db=require("./vertex/db"),entry=require("./vertex/entry"),Microservice=function(e){var r=(e.site_id,function(e){if(Object.keys(process.env).forEach(function(e,r){-1!=e.indexOf("AWS_")&&delete process.env[e]}),delete process.env.PATH,delete process.env._HANDLER,delete process.env.LD_LIBRARY_PATH,delete process.env.LAMBDA_TASK_ROOT,delete process.env.LAMBDA_RUNTIME_DIR,"prod"==process.env.TURBO_ENV){var r=new Vertex(e);return r}var r=local.app(e);return r}),t=function(){if("prod"==process.env.TURBO_ENV){var e=new Router;return e}var e=local.router();return e},n=function(e,r,t){return function(n,i,o){n.appSlug=n.headers["Turbo-Vertex-App"],t.globalConfig(e,r).then(function(e){n.global=e,o()}).catch(function(e){o()})}},i=function(e){return function(r,t,n){var i=r.vertexSession?r.vertexSession.vertexUser:null,o={vertexUser:i};if(null==utils.isValidApp(e)){var s={id:e.TURBO_APP_ID,slug:e.TURBO_APP_SLUG,schema:"site",url:r.headers.host||e.TURBO_APP_SLUG+".vertex360.co"};r.site=s,o.site=s,o.entity=s}var l={site:r.site,cdn:"dev"==e.TURBO_ENV?null:e.TURBO_CDN,global:r.global||{},vertexUser:i,preloaded:JSON.stringify(o),setEntity:function(e){o.entity=e,this.preloaded=JSON.stringify(o)},preloadData:function(e,r){o[e]=r,this.preloaded=JSON.stringify(o)}};r.config=l,r.context=l,n()}},o=function(e){return function(r,t,n){r.appSlug=r.headers["Turbo-Vertex-App"];var i=r.vertexSession?r.vertexSession.vertexUser:null,o={vertexUser:i},s={cdn:"dev"==e.TURBO_ENV?null:e.TURBO_CDN,vertexUser:o.vertexUser};if(null==utils.isValidApp(e)){var l={id:e.TURBO_APP_ID,slug:e.TURBO_APP_SLUG,schema:"site",url:r.headers.host||e.TURBO_APP_SLUG+".vertex360.co"};r.site=l,s.site=l,o.site=l,o.entity=l}s.preloaded=JSON.stringify(o),s.setEntity=function(e){o.entity=e,this.preloaded=JSON.stringify(o)},s.preloadData=function(e,r){o[e]=r,this.preloaded=JSON.stringify(o)},utils.globalConfig(e).then(function(e){r.global=e||{},s.global=e||{},r.config=s,r.context=s,n()}).catch(function(e){r.config=s,r.context=s,n()})}},s=function(e){return new Promise(function(r,t){return null==e.profile?void t(new Error("Missing Profile ID")):null==e.token?void t(new Error("Missing token")):void utils.post("https://vertex360.herokuapp.com/account/verifytoken",e).then(function(e){if("success"!=e.confirmation)throw new Error(e.message);r(e.user)}).catch(function(e){t(e)})})};return{entry:entry,express:r,app:r,router:t,fetchGlobal:n,resetPage:utils.resetPage,setConfig:i,setContext:o,APIRouter:APIRouter,Controller:Controller,ConfigRouter:ConfigRouter,nedbConfig:db.nedbConfig,utils:utils,verifyUser:s,paypalClient:PaypalClient}};module.exports=Microservice;